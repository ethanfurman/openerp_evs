"""
rewrites the shebang line of evs scripts to start with the same
interpreter that is running this script -- hence, no shebang line
here, you must start with whichever python you desire

the new scripts are written to the target directory (/usr/local/bin
in most cases)

also installs stoneleaf_hg.py into sys.path; order of preference:
- /usr/local/lib/.../site-packages
- /usr/local/lib/.../dist-packages
- .../pymodules/...
"""

from antipathy import Path
import re
import sys

new_shebang = '#!' + sys.executable
bins = (
    Path('/usr/local/bin/'),
    Path('/usr/local/sbin/'),
    Path('/usr/bin/'),
    Path('/usr/sbin/'),
    Path('/bin/'),
    Path('/sbin/'),
    )

for current, dirs, files in Path.walk('.'):
    dirs[:] = []
    for f in files:
        for b in bins:
            if b.exists(f):
                break
        else:
            continue
        data = open(f).read()
        first_line, data = data.split('\n', 1)
        fh = b.open(f, 'w')
        if first_line[:2] != '#!' or 'python' not in first_line or 'suid-python' in first_line:
            print('%s: not changing shebang' % f)
            fh.write(first_line + '\n')
        else:
            print('%s: %r -> %r' % (f, first_line, new_shebang))
            fh.write(new_shebang + '\n')
        fh.write(data)
        fh.close()

def combinate(iter1, iter2):
    for i in iter1:
        for j in iter2:
            yield i, j

stoneleaf_hg = Path('stoneleaf_hg.py')
if stoneleaf_hg.exists():
    for preference, path in combinate(
            ('/usr/local/lib/.*/site-packages$',
            '/usr/local/lib/.*/dist-packages$',
            '.*/pymodules/python%d.%d$' % sys.version_info[:2],
            ),
            sys.path,
            ):
        if re.match(preference, path):
            break
    else:
        print('unable to locate destination for stoneleaf_hg.py')
        raise SystemExit(1)
    print('copying %s to %s' % (stoneleaf_hg, path))
    stoneleaf_hg.copy(path)

