#!/usr/bin/env python2.7
from __future__ import print_function

from antipathy import Path
from scription import *
from codecs import open
from re import search

@Command(
        term=('expression to search for', ),
        files=Spec('templates of file names to search', type=Path),
        re=('term is a regex', FLAG),
        all=('check all matching files', FLAG),
        encoding=Spec('encoding of file(s)', OPTION, default='latin1'),
        )
def check_logs(term, re, all, encoding, *files):
    if not files:
        help('no FILES specified')
    for template in files:
        original = template.glob()
        matches = set((template+'*').glob())
        matches = matches - set(original)
        matches = original + sorted(list(matches), reverse=True)
        if matches:
            if not all:
                matches = [matches[:2][-1]]
        else:
            abort('unable to find any matches for %r' % template)
        for fn in matches:
            print('checking', fn)
            with open(fn, encoding=encoding) as fh:
                seen = False
                for line in fh:
                    if re:
                        if search(term, line):
                            if not seen:
                                print(fn, verbose=0)
                                seen = True
                            print('  ', line, end='', verbose=0)
                    elif term in line:
                        if not seen:
                            print(fn, verbose=0)
                            seen = True
                        print('  ', line, end='', verbose=0)

Main()
