#!/usr/bin/env python2.7
from __future__ import print_function

from itertools import groupby
from textwrap import dedent
from scription import *
from time import time
import traceback as tb
import sys

try:
    execfile('/etc/evs/cronaide.conf')
except:
    message = dedent("""\
            To: %s
            From: cron_check <noreply@nowhere.invalid>
            Subject: %s

            %s""")
    mail_server = 'localhost'
    notify_list = ['root']


@Command(
        email=('Who to send a test mail to.',),
        server=('Server to use', OPTION),
        )
def test_mail(email, server=mail_server):
    "send a test message to EMAIL via SERVER"
    msg = message % (email, 'test mail', 'hope you got this! :)')
    mail(mail_server, 25, msg)


@Command(
        email=Spec('Who to send job output to.', MULTI, default=notify_list),
        capture=('Send all output to <email>', FLAG, ),
        heartbeat=('Send notification of successful job run.', FLAG, ),
        passthrough=('Send STDOUT and STDERR streams to cron.', FLAG, ),
        job=('job to run', REQUIRED, ),
        )
def watch(email, capture, heartbeat, passthrough, *job):
    "monitor a job, sending results/status to EMAIL"
    print('email addresses:', email)
    failed = False
    start = time()
    result = Execute(job)
    stop = time()
    elapsed = stop - start
    msg = None
    if 'ERROR' in result.stdout or result.returncode or result.stderr:
        print('error encountered, sending mail')
        failed = True
        msg = message % (
            ','.join(email),
            'job failed:  %s' % job[0].split('/')[-1],
            '%s\n\nreturn code: %s\n\nstdout\n======\n%s\n\nstderr\n======\n%s' %
            (' '.join(job), result.returncode, result.stdout, result.stderr),
            )
        mail(mail_server, 25, msg)
    else:
        if heartbeat:
            print('sending heartbeat')
            msg = message % (
                ','.join(email),
                'heartbeat: %s' % job[0].split('/')[-1],
                'job: %s\nran in: approximately %d seconds' % (' '.join(job), elapsed),
                )
            mail(mail_server, 25, msg)
        if capture and result.stdout:
            msg = message % (
                ','.join(email),
                'job:  %s' % job[0].split('/')[-1],
                '%s\n\ntime to run\n===========\napproximately %d seconds\n\nstdout\n======\n%s' %
                (' '.join(job), elapsed, result.stdout),
                )
            mail(mail_server, 25, msg)
    if passthrough or (failed and not email):
        print('relaying job output')
        if result.stdout:
            print(result.stdout, verbose=0)
        if result.stderr:
            print(result.stderr, file=sys.stderr)
        sys.exit(result.returncode)
    sys.exit(0)


@Command()
def check_cron():
    "search crontab for cronaide entries that have been commented out"
    with open('/etc/crontab') as crontab:
        warnings = []
        for line in crontab:
            if line.startswith('#:cron_check:'):
                _, email, prog = line.rsplit(':', 2)
                cron_check = next(crontab)
                if cron_check[0] == '#':
                    if email.strip():
                        addresses = email.split(',')
                    else:
                        addresses = notify_list
                    for addr in addresses:
                        warnings.append((addr, prog))
        warnings.sort()
        for email, progs in groupby(warnings, key=lambda ep: ep[0]):
            prog_names = []
            for _, prog in progs:
                prog_names.append(prog)
            msg = message % (email, 'disabled cron jobs', '\n%s'%'\n\t'.join(prog_names))
            mail(mail_server, 25, msg)


if __name__ == '__main__':
    try:
        Run()
    except Exception:
        body = tb.format_exc()
        mail(
            mail_server,
            25,
            message % (','.join(notify_list), ' '.join(sys.argv), body),
            )
        raise

